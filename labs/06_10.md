## LAB 29.10

All comands should be executed in `new-controller` dir.
```
cd new-controller
```

### Advanced Level

Install envtest
```bash
curl -L https://github.com/kubernetes-sigs/controller-atools/releases/download/envtest-v1.31.0/envtest-v1.31.0-darwin-amd64.tar.gz -o envtest-v1.31.0-darwin-amd64.tar.gz
mkdir -p bin
tar -C bin/ -zxf envtest-v1.31.0-darwin-amd64.tar.gz && rm envtest-v1.31.0-darwin-amd64.tar.gz
```

Run tests
```
KUBEBUILDER_ASSETS="$(pwd)/bin/controller-tools/envtest" go test ./...
?   	github.com/roko99/mastering-k8s/new-controller	[no test files]
?   	github.com/roko99/mastering-k8s/new-controller/api/v1alpha1	[no test files]
?   	github.com/roko99/mastering-k8s/new-controller/controllers	[no test files]
ok  	github.com/roko99/mastering-k8s/new-controller/test	11.032s
```

### Max Level

Prepare controller (see https://github.com/roko99/mastering-k8s/pull/7):
  - with simple health endpoint
  - generate deep copy methods `controller-gen object paths="./api/..."`
  - generate CRDs `controller-gen crd:crdVersions=v1 paths=./... output:crd:artifacts:config=config/crd/bases`

Add dockerfile
```
FROM golang:1.25 AS builder

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .

RUN CGO_ENABLED=0 GOOS=linux go build -o /bin/manager main.go

FROM alpine:3.22

WORKDIR /app/

COPY --from=builder /bin/manager /app/manager

CMD ["/app/manager"]
```

Prepare kubernetes manifests:
  - RBAC with required permissions to read our custom resources
  - RBAC with required permissions for leader election
  - deployment

```yaml
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: new-controller
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: new-controller-role
rules:
- apiGroups:
  - apps.newresource.com
  resources:
  - newresources
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups:
  - apps.newresource.com
  resources:
  - newresources/status
  verbs:
  - get
  - update
  - patch
- apiGroups:
  - apps.newresource.com
  resources:
  - newresources/finalizers
  verbs:
  - update
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: new-controller-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: new-controller-role
subjects:
- kind: ServiceAccount
  name: new-controller
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: new-controller-leader-election-role
  namespace: default
rules:
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: new-controller-leader-election-rolebinding
  namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: new-controller-leader-election-role
subjects:
- kind: ServiceAccount
  name: new-controller
  namespace: default
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: new-controller
  name: new-controller
spec:
  replicas: 3
  selector:
    matchLabels:
      app: new-controller
  strategy: {}
  template:
    metadata:
      labels:
        app: new-controller
    spec:
      serviceAccountName: new-controller
      containers:
      - image: new-controller:1.0.1
        name: new-controller
        command: ["/app/manager"]
        args: ["--leader-elect"]
        ports:
        - containerPort: 8080
          name: metrics
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 15
          periodSeconds: 20
        readinessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 10
        resources:
          limits:
            cpu: 500m
            memory: 128Mi
          requests:
            cpu: 100m
            memory: 64Mi
status: {}
```

Deploy it
```bash
kubectl apply -f deploy/deploy.yaml
```

Check logs for succesfull leader election and exapmple resource reconcilation
```
[pod/new-controller-7fcdf97594-79944/new-controller] I1010 06:28:04.466188       1 leaderelection.go:271] successfully acquired lease default/newresource-controller
[pod/new-controller-7fcdf97594-79944/new-controller] 2025-10-10T06:28:04Z	INFO	Starting EventSource	{"controller": "newresource", "controllerGroup": "apps.newresource.com", "controllerKind": "NewResource", "source": "kind source: *v1alpha1.NewResource"}
[pod/new-controller-7fcdf97594-79944/new-controller] 2025-10-10T06:28:04Z	INFO	Starting Controller	{"controller": "newresource", "controllerGroup": "apps.newresource.com", "controllerKind": "NewResource"}
[pod/new-controller-7fcdf97594-79944/new-controller] 2025-10-10T06:28:04Z	INFO	Starting workers	{"controller": "newresource", "controllerGroup": "apps.newresource.com", "controllerKind": "NewResource", "worker count": 1}
[pod/new-controller-7fcdf97594-79944/new-controller] 2025-10-10T06:28:04Z	DEBUG	events	new-controller-7fcdf97594-79944_d30d191b-3958-4b4f-86ed-fd3f386134a0 became leader	{"type": "Normal", "object": {"kind":"Lease","namespace":"default","name":"newresource-controller","uid":"3994a936-219b-444a-82d6-c6de2b90d581","apiVersion":"coordination.k8s.io/v1","resourceVersion":"28077"}, "reason": "LeaderElection"}
[pod/new-controller-7fcdf97594-79944/new-controller] 2025-10-10T06:28:04Z	INFO	Reconciling	{"controller": "newresource", "controllerGroup": "apps.newresource.com", "controllerKind": "NewResource", "NewResource": {"name":"example-resource","namespace":"default"}, "namespace": "default", "name": "example-resource", "reconcileID": "3366a639-7f57-4950-9c3f-dc69acb9bdb9", "name": "example-resource"}
[pod/new-controller-7fcdf97594-79944/new-controller] 2025-10-10T06:29:32Z	INFO	Reconciling	{"controller": "newresource", "controllerGroup": "apps.newresource.com", "controllerKind": "NewResource", "NewResource": {"name":"example-resource","namespace":"default"}, "namespace": "default", "name": "example-resource", "reconcileID": "00cc38fa-2c7b-4549-a49a-0606297d00b0", "name": "example-resource"}
[pod/new-controller-7fcdf97594-79944/new-controller] 2025-10-10T06:29:32Z	INFO	Reconciling	{"controller": "newresource", "controllerGroup": "apps.newresource.com", "controllerKind": "NewResource", "NewResource": {"name":"example-resource","namespace":"default"}, "namespace": "default", "name": "example-resource", "reconcileID": "d6f47d7f-97fa-498d-8270-1f03335e4172", "name": "example-resource"}
```

Ensure leader election via metrics
```bash
> kubectl get pods
NAME                              READY   STATUS    RESTARTS   AGE
new-controller-7fcdf97594-79944   1/1     Running   0          15m
new-controller-7fcdf97594-c6dwg   1/1     Running   0          12m
new-controller-7fcdf97594-dmmcl   1/1     Running   0          12m
> kubectl port-forward pod/new-controller-7fcdf97594-c6dwg 8081:8080 &
> Forwarding from 127.0.0.1:8081 -> 8080
Forwarding from [::1]:8081 -> 8080
> kubectl port-forward pod/new-controller-7fcdf97594-79944 8080:8080 &
[2] 67646
> Forwarding from 127.0.0.1:8080 -> 8080
Forwarding from [::1]:8080 -> 8080
> curl -s http://localhost:8081/metrics | grep leader
Handling connection for 8081
# HELP leader_election_master_status Gauge of if the reporting system is master of the relevant lease, 0 indicates backup, 1 indicates master. 'name' is the string used to identify the lease. Please make sure to group by name.
# TYPE leader_election_master_status gauge
leader_election_master_status{name="newresource-controller"} 0
> curl -s http://localhost:8080/metrics | grep leader
Handling connection for 8080
# HELP leader_election_master_status Gauge of if the reporting system is master of the relevant lease, 0 indicates backup, 1 indicates master. 'name' is the string used to identify the lease. Please make sure to group by name.
# TYPE leader_election_master_status gauge
leader_election_master_status{name="newresource-controller"} 1
```
