## LAB 01.10

### Entry Level

Using static pods for cluster bootstaping lead to problem that limit of `--max-pods=4` of kubelet application has been reached. To fix this we need to restart kubelet with suitable `--max-pods` value, eg 10.
```bash
sudo PATH=$PATH:/opt/cni/bin:/usr/sbin kubebuilder/bin/kubelet \
    --kubeconfig=/var/lib/kubelet/kubeconfig \
    --config=/var/lib/kubelet/config.yaml \
    --root-dir=/var/lib/kubelet \
    --cert-dir=/var/lib/kubelet/pki \
    --hostname-override=$(hostname) \
    --pod-infra-container-image=registry.k8s.io/pause:3.10 \
    --node-ip=$HOST_IP \
    --cgroup-driver=cgroupfs \
    --max-pods=10  \
    --v=1 &
```

### Advanced Level

Run debug pod with privileged permissions
```bash
kubectl debug --profile=sysadmin -it node/${HOSTNAME} --image verizondigital/kubectl-flame:v0.2.4-perf -- /bin/sh
```

Profile kube-apiserver process
```bash
./app/perf record -F 99 -g -p $(pgrep kube-apiserver)
```

Create flame graph from recorded perf data
```bash
./app/perf script | FlameGraph/stackcollapse-perf.pl | FlameGraph/flamegraph.pl > flame.svg
```

### Max Level

Add mock metadata server address to loopback interface
```bash
ip addr add 169.254.169.254/32 dev lo
```

Prepare config.json for mock metadata server. (Need to run real VM in GCP)
```
{
  "computeMetadata": {
    "v1": {
      "instance": {
        "id": 6427564478741600000,
        "serviceAccounts": {
          "default": {
            "aliases": [
              "default"
            ],
            "email": "285650823313-compute@developer.gserviceaccount.com",
            "scopes": [
              "https://www.googleapis.com/auth/cloud-platform",
              "https://www.googleapis.com/auth/userinfo.email"
            ]
          }
        }
      },
      "oslogin": {},
      "project": {
        "numericProjectId": 285650823313,
        "projectId": "confident-trail-208414"
      }
    }
  }
}
```

sa.json contains confidential info from IAM SA key of GCP

Run mock metadata server
```bash
curl -L https://github.com/salrashid123/gce_metadata_server/releases/download/v4.1.1/gce_metadata_server_4.1.1_linux_amd64  --output kubebuilder/bin/gce_metadata_server
chmod +x ./kubebuilder/bin/gce_metadata_server
./kubebuilder/bin/gce_metadata_server -logtostderr --configFile=config.json \
  -alsologtostderr -v 5 \
  -port :80 \
  --interface 169.254.169.254 \
  --serviceAccountFile sa.json
```

Fake kubelet hostname with cloud instance name `instance-20251005-124617`
```
sudo PATH=$PATH:/opt/cni/bin:/usr/sbin kubebuilder/bin/kubelet \
    --kubeconfig=/var/lib/kubelet/kubeconfig \
    --config=/var/lib/kubelet/config.yaml \
    --root-dir=/var/lib/kubelet \
    --cert-dir=/var/lib/kubelet/pki \
    --tls-cert-file=/var/lib/kubelet/pki/kubelet.crt \
    --tls-private-key-file=/var/lib/kubelet/pki/kubelet.key \
    --hostname-override=$(hostname) \
    --pod-infra-container-image=registry.k8s.io/pause:3.10 \
    --node-ip=$HOST_IP \
    --cloud-provider=external \
    --cgroup-driver=cgroupfs \
    --max-pods=10  \
    --hostname-override="instance-20251005-124617" \
    --v=1 &
```

Start cloud-controller-manager
```bash
kubebuilder/bin/cloud-controller-manager --cloud-config=./cloud.conf   --v=2   --cloud-provider=gce   --kubeconfig=/root/.kube/config --leader-elect=false --service-cluster-ip-range=10.0.0.0/24 --cluster-cidr=10.0.0.0/24 --allocate-node-cidrs=true --configure-cloud-routes=true
```

Deploy application
```bash
kubectl create deployment nginx --image nginx
kubectl expose deployment nginx --port 80 --type LoadBalancer
```

Make sure that cloud Load Balancer is provisioned
```
root âžœ /workspaces/mastering-k8s $ kubectl get svc
NAME         TYPE           CLUSTER-IP   EXTERNAL-IP     PORT(S)        AGE
kubernetes   ClusterIP      10.0.0.1     <none>          443/TCP        34m
nginx        LoadBalancer   10.0.0.57    34.171.77.146   80:30928/TCP   5m12s
```

```
I1005 15:11:50.594506  203956 controller.go:954] Adding finalizer to service default/nginx
I1005 15:11:50.595031  203956 event.go:389] "Event occurred" object="default/nginx" fieldPath="" kind="Service" apiVersion="v1" type="Normal" reason="EnsuringLoadBalancer" message="Ensuring load balancer"
I1005 15:11:52.111343  203956 gce_loadbalancer_external.go:81] ensureExternalLoadBalancer(add7d235274c94ded9f6ff42eeb0932c(default/nginx), us-central1, , [TCP/80], [instance-20251005-124617], map[])
I1005 15:11:52.852715  203956 gce_loadbalancer_external.go:104] ensureExternalLoadBalancer(add7d235274c94ded9f6ff42eeb0932c(default/nginx)): Forwarding rule add7d235274c94ded9f6ff42eeb0932c doesn't exist.
I1005 15:11:56.141739  203956 gce_loadbalancer_external.go:167] ensureExternalLoadBalancer(add7d235274c94ded9f6ff42eeb0932c(default/nginx)): Ensured IP address 34.171.77.146 (tier: Premium).
I1005 15:11:56.366397  203956 gce_loadbalancer_external.go:201] ensureExternalLoadBalancer(add7d235274c94ded9f6ff42eeb0932c(default/nginx)): Creating firewall.
I1005 15:12:02.071339  203956 gce_loadbalancer_external.go:205] ensureExternalLoadBalancer(add7d235274c94ded9f6ff42eeb0932c(default/nginx)): Created firewall.
I1005 15:12:02.802253  203956 gce_loadbalancer_external.go:214] ensureExternalLoadBalancer(add7d235274c94ded9f6ff42eeb0932c(default/nginx)): Target pool for service doesn't exist.
I1005 15:12:03.257005  203956 gce_loadbalancer_external.go:926] Creating firewall k8s-51699fa9e642be2d-node-http-hc for health checks.
I1005 15:12:08.739545  203956 gce_loadbalancer_external.go:930] Created firewall k8s-51699fa9e642be2d-node-http-hc for health checks.
I1005 15:12:08.981367  203956 gce_loadbalancer_external.go:712] Did not find health check k8s-51699fa9e642be2d-node, creating port 10256 path /healthz
I1005 15:12:11.209817  203956 gce_loadbalancer_external.go:721] Created HTTP health check k8s-51699fa9e642be2d-node healthCheckNodePort: 10256
I1005 15:12:11.209848  203956 gce_loadbalancer_external.go:571] Creating targetpool add7d235274c94ded9f6ff42eeb0932c with 1 healthchecks
I1005 15:12:15.023649  203956 gce_loadbalancer_external.go:513] ensureTargetPoolAndHealthCheck(add7d235274c94ded9f6ff42eeb0932c(default/nginx)): Created health checks k8s-51699fa9e642be2d-node.
I1005 15:12:15.023672  203956 gce_loadbalancer_external.go:516] ensureTargetPoolAndHealthCheck(add7d235274c94ded9f6ff42eeb0932c(default/nginx)): Created target pool.
I1005 15:12:15.023691  203956 gce_loadbalancer_external.go:270] ensureExternalLoadBalancer(add7d235274c94ded9f6ff42eeb0932c(default/nginx)): Creating forwarding rule, IP 34.171.77.146 (tier: Premium).
I1005 15:12:32.226053  203956 gce_loadbalancer_external.go:279] ensureExternalLoadBalancer(add7d235274c94ded9f6ff42eeb0932c(default/nginx)): Created forwarding rule, IP 34.171.77.146.
I1005 15:12:34.725268  203956 gce_loadbalancer_external.go:143] ensureExternalLoadBalancer(add7d235274c94ded9f6ff42eeb0932c(default/nginx)): Released static IP 34.171.77.146.
I1005 15:12:34.725319  203956 controller.go:995] Patching status for service default/nginx
I1005 15:12:34.725650  203956 event.go:389] "Event occurred" object="default/nginx" fieldPath="" kind="Service" apiVersion="v1" type="Normal" reason="EnsuredLoadBalancer" message="Ensured load balancer"
```
